<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>홈화면</title>
</head>
<body>
	<th:block>
		<h1>할 일 목록</h1>
		<table border="1">
			<tbody>
				<tr>
					<th>완료</th>
					<th>번호</th>
					<th>내용</th>
					<th>삭제</th>
				</tr>
				<tr th:if="${#lists.isEmpty(todoList)}">
					<td colspan="4">조회된 데이터가 없습니다</td>
				</tr>
				<tr th:if="${!#lists.isEmpty(todoList)}"
					th:each="todo, vs : ${todoList}">
						<td><input type="checkbox" th:checked="${todo.flag == 'Y'}" class="chk-flag" th:attr="data-no=${todo.no}"></td>
						<td th:text="${vs.count}">번호</td>
						<td th:text="${todo.content}">내용</td>
						<td><input type="button" value="삭제"></td>
				</tr>
			</tbody>
		</table>
		
		<h1>할 일 추가</h1>
		<form name="create_todo_form">
			<input type="text" name="content" placeholder="할일을 입력하세요.">
			<input type="submit" value="추가하기">
		</form>
		
		<script>
			// 할 일을 추가하는 로직
			const form = document.create_todo_form;
			form.addEventListener("submit", function(event){
				event.preventDefault();
				
				let vali_check = false;
				let vali_text = "";
				
				if(!form.content.value) {
					vali_text += "할일을 입력하세요.";
				} else {
					vali_check = true;
				}
				
				if(vali_check == false) {
					alert(vali_text);
				} else {
					const payload = new FormData(form);
					
					fetch("/todo", {
						method : 'post',
						body : payload
					})
					.then(response => response.json())
					.then(data => {
						alert(data.res_msg);
						if(data.res_code == '200') {
							location.href = "/";
						}
					})
					.catch(error => {
						console.log(error);
					})
				}
			});
			
			// 완료 여부를 수정하는 로직
			document.querySelectorAll(".chk-flag").forEach((checkbox) => {
				checkbox.addEventListener("change", function (event) {
			        const no = event.target.dataset.no;
			        const flag = event.target.checked;
			        
			        fetch("/todo/"+no+"/update", {
						method : "post",
						headers: {
			                "Content-Type": "application/json"
			            },
			            body: JSON.stringify({
							flag: flag
						})
					})
					.then(response => response.json())
					.then(data => {
						if(data.res_code == '500') {
							alert(data.res_msg);		
						}
					})
					.catch(error => {
						console.log(error);
					})
				});
			});
			
			// 할 일을 삭제하는 로직
			document.querySelectorAll(".chk-flag").forEach((checkbox) => {
				checkbox.addEventListener("change", function (event) {
			        const no = event.target.dataset.no;
			        
			        fetch("/todo/"+no+"/delete", {
						method : "post"
					})
					.then(response => response.json())
					.then(data => {
						if(data.res_code == '500') {
							alert(data.res_msg);		
						}
					})
					.catch(error => {
						console.log(error);
					})
				});
			});

		</script>
	<th:block>
</body>
</html>